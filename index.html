<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitor Case Tracker</title>
    <!-- Modern Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            --primary: #0070f3;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #fafafa;
            --card-bg: #ffffff;
            --text: #171717;
            --border: #eaeaea;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; padding: 20px; 
            background: var(--bg); 
            color: var(--text);
            line-height: 1.5;
        }

        .container { 
            max-width: 1200px; margin: 0 auto; 
            background: var(--card-bg); 
            padding: 32px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        h1 { margin: 0; font-size: 24px; font-weight: 700; }

        .controls { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 24px;
        }

        button { 
            background: #000; color: white; border: none; 
            padding: 10px 18px; border-radius: 8px; 
            cursor: pointer; font-size: 14px; font-weight: 500;
            transition: all 0.2s;
        }

        button:hover { background: #333; transform: translateY(-1px); }
        button.export { background: var(--success); }
        button.sync { background: var(--primary); }
        button.secondary { background: #666; }

        .search-bar {
            width: 100%; padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 20px;
            font-size: 14px; box-sizing: border-box;
        }

        .form-section { 
            background: #f9f9f9; padding: 24px; border-radius: 8px; 
            margin-bottom: 24px; border: 1px solid var(--border);
            display: none; 
        }
        .form-section.show { display: block; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .form-row.full { grid-template-columns: 1fr; }

        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 12px; color: #666; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid var(--border); 
            border-radius: 6px; font-size: 14px; box-sizing: border-box;
        }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { 
            background: #fafafa; padding: 12px; text-align: left; 
            font-size: 12px; text-transform: uppercase; color: #666;
            border-bottom: 2px solid var(--border); 
        }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        /* Badges */
        .status { 
            padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; 
        }
        .status-new { background: #eff6ff; color: #1e40af; }
        .status-progress { background: #fffbeb; color: #92400e; }
        .status-closed { background: #ecfdf5; color: #065f46; }

        .priority-high { color: var(--danger); font-weight: 700; }

        .stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 20px; margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;
        }
        .stat-card { background: #fdfdfd; padding: 16px; border-radius: 8px; border: 1px solid var(--border); }
        .stat-label { font-size: 12px; color: #666; display: block; }
        .stat-value { font-size: 20px; font-weight: 700; color: var(--primary); }

        .folder-link { color: var(--primary); text-decoration: none; font-weight: 600; }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Solicitor Case Tracker</h1>
        <span id="syncStatus" style="font-size: 12px; color: #666;"></span>
    </header>
  
    <div class="controls">
        <button onclick="toggleForm()">+ New Case</button>
        <button class="sync" onclick="syncSheets()">Sync to Cloud</button>
        <button class="sync" onclick="loadFromSheets()" style="background:#555">Load from Cloud</button>
        <button class="export" onclick="exportCSV()">Export CSV</button>
    </div>

    <input type="text" id="searchInput" class="search-bar" placeholder="Search by Client, Ref, or Solicitor..." onkeyup="render()">

    <div class="form-section" id="form">
        <h2 id="formTitle">Add New Case</h2>
        <div class="form-row">
            <div><label>Case Reference *</label><input type="text" id="caseRef"></div>
            <div><label>Client Name *</label><input type="text" id="clientName"></div>
        </div>
        <div class="form-row">
            <div><label>Case Type</label>
                <select id="caseType">
                    <option>Criminal</option><option>Civil</option><option>Family</option><option>Conveyancing</option><option>Other</option>
                </select>
            </div>
            <div><label>Status</label>
                <select id="status">
                    <option>New</option><option>In Progress</option><option>On Hold</option><option>Closed</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div><label>Next Review</label><input type="date" id="nextReview"></div>
            <div><label>Priority</label>
                <select id="priority"><option>Low</option><option selected>Medium</option><option>High</option></select>
            </div>
        </div>
        <div class="form-row">
            <div><label>Assigned Solicitor</label><input type="text" id="solicitor"></div>
            <div><label>Upload Doc to Drive</label><input type="file" id="fileInput"></div>
        </div>
        <div class="form-row full">
            <div><label>Notes</label><textarea id="notes"></textarea></div>
        </div>
        <button id="saveBtn" onclick="saveCase()">Save Case</button>
        <button class="secondary" onclick="toggleForm()">Cancel</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ref</th><th>Client</th><th>Status</th><th>Priority</th><th>Solicitor</th><th>Drive</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <div class="stats">
        <div class="stat-card"><span class="stat-label">Total Cases</span><span class="stat-value" id="total">0</span></div>
        <div class="stat-card"><span class="stat-label">Active</span><span class="stat-value" id="active">0</span></div>
        <div class="stat-card"><span class="stat-label">Closed</span><span class="stat-value" id="closed">0</span></div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDViazN3iDOSxBhBk7xdUrCK4la0kpv5uOtS0sSz_f-VZ28YVkyxDdR1eoS2YRIvYr/exec'; 

let cases = JSON.parse(localStorage.getItem('cases')) || [];
let editingId = null;

// --- CORE FUNCTIONS ---

function toggleForm() {
    const f = document.getElementById('form');
    f.classList.toggle('show');
    if (!f.classList.contains('show')) resetForm();
}

function resetForm() {
    editingId = null;
    document.getElementById('formTitle').innerText = "Add New Case";
    document.getElementById('caseRef').value = '';
    document.getElementById('clientName').value = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('notes').value = '';
}

async function saveCase() {
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.innerText = "Saving...";

    const ref = document.getElementById('caseRef').value;
    const client = document.getElementById('clientName').value;
    if(!ref || !client) return alert("Ref and Client required");

    const fileInput = document.getElementById('fileInput');
    let fileObj = null;

    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const base64 = await toBase64(file);
        fileObj = { data: base64.split(',')[1], name: file.name, type: file.type };
    }

    const newCase = {
        id: editingId || Date.now(),
        caseRef: ref,
        clientName: client,
        caseType: document.getElementById('caseType').value,
        status: document.getElementById('status').value,
        nextReview: document.getElementById('nextReview').value,
        priority: document.getElementById('priority').value,
        solicitor: document.getElementById('solicitor').value,
        notes: document.getElementById('notes').value,
        folderUrl: editingId ? (cases.find(c => c.id === editingId).folderUrl || "") : ""
    };

    if (editingId) {
        cases = cases.map(c => c.id === editingId ? newCase : c);
    } else {
        cases.push(newCase);
    }

    // Immediately Sync so Google creates the folder/saves file
    await performSync(newCase.caseRef, fileObj);

    localStorage.setItem('cases', JSON.stringify(cases));
    btn.disabled = false; btn.innerText = "Save Case";
    toggleForm();
    render();
}

async function performSync(specificRef = null, fileObj = null) {
    const statusEl = document.getElementById('syncStatus');
    statusEl.innerText = "Syncing with Cloud...";
    
    const payload = {
        cases: cases,
        targetRef: specificRef,
        file: fileObj
    };

    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        });
        statusEl.innerText = "Synced Successfully";
        // Reload to get folder URLs
        setTimeout(loadFromSheets, 1500);
    } catch (e) {
        statusEl.innerText = "Sync Failed";
    }
}

function loadFromSheets() {
    fetch(SCRIPT_URL).then(r => r.json()).then(data => {
        cases = data;
        localStorage.setItem('cases', JSON.stringify(cases));
        render();
    });
}

function deleteCase(id) {
    if(confirm("Delete case?")) {
        cases = cases.filter(c => c.id !== id);
        localStorage.setItem('cases', JSON.stringify(cases));
        performSync();
        render();
    }
}

function editCase(id) {
    const c = cases.find(x => x.id === id);
    editingId = id;
    document.getElementById('formTitle').innerText = "Edit Case";
    document.getElementById('caseRef').value = c.caseRef;
    document.getElementById('clientName').value = c.clientName;
    document.getElementById('caseType').value = c.caseType;
    document.getElementById('status').value = c.status;
    document.getElementById('nextReview').value = c.nextReview;
    document.getElementById('priority').value = c.priority;
    document.getElementById('solicitor').value = c.solicitor;
    document.getElementById('notes').value = c.notes;
    document.getElementById('form').classList.add('show');
}

// --- UTILS ---

function render() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    const filtered = cases.filter(c => 
        c.clientName.toLowerCase().includes(query) || 
        c.caseRef.toLowerCase().includes(query) ||
        c.solicitor.toLowerCase().includes(query)
    );

    filtered.forEach(c => {
        const row = `<tr>
            <td><strong>${c.caseRef}</strong></td>
            <td>${c.clientName}</td>
            <td><span class="status ${getStatusClass(c.status)}">${c.status}</span></td>
            <td><span class="${c.priority === 'High' ? 'priority-high' : ''}">${c.priority}</span></td>
            <td>${c.solicitor}</td>
            <td>${c.folderUrl ? `<a href="${c.folderUrl}" target="_blank" class="folder-link">üìÅ View</a>` : '...'}</td>
            <td>
                <button class="secondary" style="padding:5px 10px" onclick="editCase(${c.id})">Edit</button>
                <button class="secondary" style="padding:5px 10px; background:var(--danger)" onclick="deleteCase(${c.id})">Del</button>
            </td>
        </tr>`;
        tbody.innerHTML += row;
    });

    updateStats();
}

function updateStats() {
    document.getElementById('total').innerText = cases.length;
    document.getElementById('active').innerText = cases.filter(c => c.status !== 'Closed').length;
    document.getElementById('closed').innerText = cases.filter(c => c.status === 'Closed').length;
}

function getStatusClass(s) {
    if(s === 'New') return 'status-new';
    if(s === 'In Progress') return 'status-progress';
    if(s === 'Closed') return 'status-closed';
    return '';
}

const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

// Init
render();
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
</script>
</body>
</html>
