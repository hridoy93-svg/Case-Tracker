<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_lcXiklVTSI202nyYttSrk0BqbLJr6YYQEHkvo8x8Um8zamvySLXPULfq3dFA-abj/exec'; 

    let cases = JSON.parse(localStorage.getItem('cases')) || [];
    let editingId = null;

    function toggleForm() {
        const form = document.getElementById('form');
        form.classList.toggle('show');
        if (!form.classList.contains('show')) resetForm();
    }

    function resetForm() {
        editingId = null;
        document.getElementById('formTitle').innerText = "Add Case";
        document.getElementById('caseRef').value = '';
        document.getElementById('clientName').value = '';
        document.getElementById('solicitor').value = '';
        document.getElementById('fileInput').value = '';
    }

    async function saveCase() {
        const ref = document.getElementById('caseRef').value;
        const client = document.getElementById('clientName').value;
        if (!ref || !client) return alert("Ref and Client are required");

        const btn = document.getElementById('saveBtn');
        btn.disabled = true; btn.innerText = "Syncing...";

        // Handle File conversion immediately
        const fileInput = document.getElementById('fileInput');
        let fileData = null;
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const base64 = await toBase64(file);
            fileData = { data: base64.split(',')[1], name: file.name, type: file.type };
        }

        const caseObj = {
            id: editingId || Date.now(),
            caseRef: ref,
            clientName: client,
            status: document.getElementById('status').value || "New",
            solicitor: document.getElementById('solicitor').value || "",
            nextReview: document.getElementById('nextReview').value || "",
            folderUrl: editingId ? (cases.find(c => c.id == editingId)?.folderUrl || "") : ""
        };

        // Update LOCAL state immediately (This prevents it from "deleting")
        if (editingId) {
            cases = cases.map(c => c.id == editingId ? caseObj : c);
        } else {
            cases.push(caseObj);
        }

        localStorage.setItem('cases', JSON.stringify(cases));
        render(); // Show the user the new case right now
        
        // Push to cloud in the background
        await syncToCloud(caseObj.caseRef, fileData);
        
        btn.disabled = false; btn.innerText = "Save Case & Sync";
        toggleForm();
    }

    async function syncToCloud(targetRef = null, fileObj = null) {
        updateStatus("‚òÅÔ∏è Syncing...");
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ cases, targetRef, file: fileObj })
            });
            updateStatus("‚úÖ Cloud Updated");
            // WE DO NOT AUTO-LOAD HERE. It's too fast for Google.
        } catch (e) {
            updateStatus("‚ùå Sync Error");
        }
    }

    async function loadFromCloud() {
        updateStatus("‚è≥ Loading...");
        try {
            const resp = await fetch(SCRIPT_URL);
            const data = await resp.json();
            if (data && Array.isArray(data) && data.length > 0) {
                // Merge data: keep local folderUrls if cloud is missing them
                cases = data;
                localStorage.setItem('cases', JSON.stringify(cases));
                render();
                updateStatus("‚úÖ Loaded");
            } else {
                updateStatus("‚ö†Ô∏è Cloud is empty");
            }
        } catch (e) {
            updateStatus("‚ùå Load Failed");
        }
    }

    function render() {
        const query = (document.getElementById('searchInput').value || "").toLowerCase();
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        const filtered = cases.filter(c => 
            (c.clientName || "").toLowerCase().includes(query) || 
            (c.caseRef || "").toLowerCase().includes(query)
        );

        filtered.forEach(c => {
            const row = `<tr>
                <td><strong>${c.caseRef}</strong></td>
                <td>${c.clientName}</td>
                <td><span class="badge status-${(c.status || 'new').toLowerCase().replace(' ', '')}">${c.status}</span></td>
                <td>${c.solicitor || '-'}</td>
                <td>${c.folderUrl ? `<a href="${c.folderUrl}" target="_blank" class="drive-link">üìÅ View</a>` : '<i>Syncing...</i>'}</td>
                <td>
                    <button class="secondary" style="padding:4px 8px" onclick="editCase(${c.id})">Edit</button>
                    <button class="danger" style="padding:4px 8px" onclick="deleteCase(${c.id})">Del</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        document.getElementById('totalCount').innerText = cases.length;
        document.getElementById('activeCount').innerText = cases.filter(c => c.status !== 'Closed').length;
        document.getElementById('closedCount').innerText = cases.filter(c => c.status === 'Closed').length;
    }

    // [Keep helper functions updateStatus, deleteCase, editCase, exportCSV, toBase64 as they were]
</script>
