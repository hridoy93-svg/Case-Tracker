<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitor Case Tracker</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            --primary: #000000;
            --secondary: #666666;
            --accent: #0070f3;
            --danger: #e00;
            --bg: #fafafa;
            --card: #ffffff;
            --border: #eaeaea;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #111; margin: 0; padding: 20px; }
        
        .container { max-width: 1100px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 22px; letter-spacing: -0.5px; }
        
        /* Status Bar */
        #syncStatus { font-size: 13px; font-weight: 500; color: var(--secondary); transition: color 0.3s; }
        .status-ok { color: #10b981 !important; }
        .status-err { color: var(--danger) !important; }

        /* Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        button:hover { opacity: 0.8; transform: translateY(-1px); }
        button.outline { background: transparent; border: 1px solid var(--border); color: #333; }
        button.outline:hover { background: #f5f5f5; }
        button.danger { background: #fff; border: 1px solid #fee; color: var(--danger); }
        button.danger:hover { background: #fff5f5; }

        /* Form */
        .form-panel { background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; display: none; }
        .form-panel.open { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .full { grid-column: span 2; }
        
        label { display: block; font-size: 11px; text-transform: uppercase; color: var(--secondary); font-weight: 700; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; box-sizing: border-box; background: #fff; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); ring: 2px solid rgba(0,112,243,0.1); }

        /* Table */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; color: var(--secondary); font-size: 12px; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge.New { background: #e0f2fe; color: #0284c7; }
        .badge.In.Progress { background: #fef3c7; color: #d97706; }
        .badge.Closed { background: #dcfce7; color: #16a34a; }

        .stats { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); display: flex; gap: 30px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-val { font-size: 24px; font-weight: 700; }
        .stat-lbl { font-size: 12px; color: var(--secondary); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Solicitor Case Tracker</h1>
        <span id="syncStatus">Ready</span>
    </header>

    <div class="controls">
        <button onclick="openForm()">+ New Case</button>
        <button class="outline" onclick="syncToCloud()">‚òÅÔ∏è Sync to Cloud</button>
        <button class="outline" onclick="loadFromCloud()">üîÑ Refresh List</button>
        <button class="outline" onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
    </div>

    <div id="caseForm" class="form-panel">
        <div class="grid">
            <div><label>Case Reference</label><input type="text" id="caseRef" placeholder="CASE-123"></div>
            <div><label>Client Name</label><input type="text" id="clientName" placeholder="John Doe"></div>
        </div>
        <div class="grid">
            <div><label>Status</label><select id="status"><option>New</option><option>In Progress</option><option>Closed</option></select></div>
            <div><label>Solicitor</label><input type="text" id="solicitor"></div>
        </div>
        <div class="grid">
            <div><label>Next Review</label><input type="date" id="nextReview"></div>
            <div><label>Upload File (Optional)</label><input type="file" id="fileInput"></div>
        </div>
        <div class="grid"><div class="full"><label>Notes</label><textarea id="notes" rows="3"></textarea></div></div>
        <div style="margin-top:15px">
            <button onclick="saveCase()">Save Case</button>
            <button class="outline" onclick="closeForm()">Cancel</button>
        </div>
    </div>

    <div class="table-wrap">
        <table>
            <thead><tr><th>Ref</th><th>Client</th><th>Status</th><th>Solicitor</th><th>Drive</th><th>Actions</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="stats">
        <div class="stat-item"><span class="stat-val" id="totalCount">0</span><span class="stat-lbl">Total Cases</span></div>
        <div class="stat-item"><span class="stat-val" id="activeCount">0</span><span class="stat-lbl">Active</span></div>
    </div>
</div>

<script>
    // --- SETUP ---
    // 1. Deploy your Google Script
    // 2. Paste the 'Web App URL' inside the quotes below
    const SCRIPT_URL = 'PASTE_YOUR_GOOGLE_SCRIPT_URL_HERE';
    
    let cases = JSON.parse(localStorage.getItem('cases') || '[]');
    let editingId = null;

    // --- MAIN LOGIC ---

    function render() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        if (cases.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">No cases found. Add one locally or load from cloud.</td></tr>';
        } else {
            cases.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${c.caseRef}</strong></td>
                    <td>${c.clientName}</td>
                    <td><span class="badge ${c.status}">${c.status}</span></td>
                    <td>${c.solicitor || '-'}</td>
                    <td>${c.folderUrl ? `<a href="${c.folderUrl}" target="_blank" style="color:#0070f3;text-decoration:none;font-weight:600">üìÇ Folder</a>` : '<span style="color:#ccc">...</span>'}</td>
                    <td>
                        <button class="outline" style="padding:4px 8px;font-size:11px" onclick="editCase(${c.id})">Edit</button>
                        <button class="danger" style="padding:4px 8px;font-size:11px" onclick="deleteCase(${c.id})">Del</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        updateStats();
    }

    async function saveCase() {
        const ref = document.getElementById('caseRef').value;
        const name = document.getElementById('clientName').value;
        if (!ref || !name) return alert("Ref and Client Name are required.");

        const statusLabel = document.getElementById('syncStatus');
        statusLabel.innerText = "Processing File...";

        // Handle File
        const fileInput = document.getElementById('fileInput');
        let fileData = null;
        if (fileInput.files.length > 0) {
            fileData = await readFile(fileInput.files[0]);
        }

        const caseData = {
            id: editingId || Date.now(),
            caseRef: ref,
            clientName: name,
            status: document.getElementById('status').value,
            solicitor: document.getElementById('solicitor').value,
            nextReview: document.getElementById('nextReview').value,
            notes: document.getElementById('notes').value,
            folderUrl: editingId ? cases.find(c => c.id === editingId).folderUrl : ""
        };

        // Update Local State FIRST (Instant UI)
        if (editingId) {
            cases = cases.map(c => c.id === editingId ? caseData : c);
        } else {
            cases.push(caseData);
        }
        
        localStorage.setItem('cases', JSON.stringify(cases));
        closeForm();
        render();

        // Sync to Cloud in Background
        syncToCloud(caseData.caseRef, fileData);
    }

    async function syncToCloud(targetRef = null, filePayload = null) {
        const lbl = document.getElementById('syncStatus');
        lbl.innerText = "‚òÅÔ∏è Syncing...";
        lbl.className = "";

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cases: cases,
                    targetRef: targetRef,
                    file: filePayload
                })
            });
            lbl.innerText = "‚úÖ Saved to Drive";
            lbl.className = "status-ok";
            
            // If we just uploaded a file, reload to get the new Folder URL
            if (filePayload) {
                setTimeout(loadFromCloud, 2000); 
            }
        } catch (e) {
            console.error(e);
            lbl.innerText = "‚ùå Sync Failed";
            lbl.className = "status-err";
        }
    }

    async function loadFromCloud() {
        const lbl = document.getElementById('syncStatus');
        lbl.innerText = "üîÑ Loading...";
        
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json(); // If this fails, Script URL is wrong or Script crashed
            
            if (Array.isArray(data)) {
                cases = data.map(c => ({
                    ...c,
                    id: Number(c.id) || Date.now() // Ensure ID is number
                }));
                localStorage.setItem('cases', JSON.stringify(cases));
                render();
                lbl.innerText = "‚úÖ Loaded";
                lbl.className = "status-ok";
            } else {
                throw new Error("Invalid Data");
            }
        } catch (e) {
            console.error(e);
            lbl.innerText = "‚ùå Load Failed";
            lbl.className = "status-err";
            alert("Could not load from Google Sheets. \n1. Check your SCRIPT_URL.\n2. Ensure Deployment is 'Anyone'.");
        }
    }

    function deleteCase(id) {
        if(!confirm("Delete this case?")) return;
        cases = cases.filter(c => c.id !== id);
        localStorage.setItem('cases', JSON.stringify(cases));
        render();
        syncToCloud(); // Sync the deletion
    }

    function editCase(id) {
        const c = cases.find(x => x.id === id);
        editingId = id;
        document.getElementById('caseRef').value = c.caseRef;
        document.getElementById('clientName').value = c.clientName;
        document.getElementById('status').value = c.status;
        document.getElementById('solicitor').value = c.solicitor;
        document.getElementById('nextReview').value = c.nextReview;
        document.getElementById('notes').value = c.notes;
        openForm();
    }

    function exportCSV() {
        const headers = ["ID","Ref","Client","Status","Solicitor","Review","Notes","Folder"];
        const rows = cases.map(c => [c.id, c.caseRef, c.clientName, c.status, c.solicitor, c.nextReview, c.notes, c.folderUrl]);
        
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" 
            + rows.map(e => e.join(",")).join("\n");
            
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "cases.csv");
        document.body.appendChild(link);
        link.click();
    }

    // --- HELPERS ---
    function openForm() { document.getElementById('caseForm').classList.add('open'); }
    function closeForm() { 
        document.getElementById('caseForm').classList.remove('open'); 
        document.getElementById('caseRef').value = '';
        document.getElementById('clientName').value = '';
        document.getElementById('fileInput').value = '';
        editingId = null;
    }
    function updateStats() {
        document.getElementById('totalCount').innerText = cases.length;
        document.getElementById('activeCount').innerText = cases.filter(c => c.status !== 'Closed').length;
    }
    const readFile = (file) => new Promise(r => {
        const reader = new FileReader();
        reader.onload = () => r({ name: file.name, type: file.type, data: reader.result.split(',')[1] });
        reader.readAsDataURL(file);
    });

    // Init
    render();
</script>
</body>
</html>
