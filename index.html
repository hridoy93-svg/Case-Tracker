<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitor Case Tracker</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            --primary: #0070f3;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #fafafa;
            --card-bg: #ffffff;
            --text: #171717;
            --border: #eaeaea;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; padding: 20px; 
            background: var(--bg); color: var(--text);
            line-height: 1.5;
        }

        .container { 
            max-width: 1100px; margin: 0 auto; 
            background: var(--card-bg); padding: 30px; 
            border-radius: 12px; border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 22px; font-weight: 700; }

        .status-msg { font-size: 13px; font-weight: 600; color: var(--primary); min-height: 20px; }

        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        
        button { 
            background: #000; color: #fff; border: none; padding: 10px 16px; 
            border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
            transition: 0.2s;
        }
        button:hover { background: #333; transform: translateY(-1px); }
        button.secondary { background: #f0f0f0; color: #000; border: 1px solid var(--border); }
        button.danger { background: var(--danger); color: white; }

        .search-bar {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 20px; font-size: 14px; box-sizing: border-box;
        }

        .form-section { 
            display: none; background: #f9f9f9; padding: 20px; 
            border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; 
        }
        .form-section.show { display: block; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid var(--border); 
            border-radius: 6px; font-size: 14px; box-sizing: border-box;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; font-size: 12px; color: #888; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .status-new { background: #e0f2fe; color: #0369a1; }
        .status-inprogress { background: #fef3c7; color: #92400e; }
        .status-closed { background: #dcfce7; color: #166534; }

        .stats { display: flex; gap: 15px; margin-top: 25px; }
        .stat-card { background: #fff; padding: 15px; border: 1px solid var(--border); border-radius: 8px; flex: 1; }
        .stat-val { font-size: 20px; font-weight: 700; display: block; }
        .stat-lbl { font-size: 12px; color: #666; }

        a.drive-link { color: var(--primary); text-decoration: none; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Case Tracker</h1>
        <div id="syncStatus" class="status-msg"></div>
    </header>

    <div class="controls">
        <button onclick="toggleForm()">+ New Case</button>
        <button class="secondary" onclick="syncToCloud()">‚òÅÔ∏è Sync to Cloud</button>
        <button class="secondary" onclick="loadFromCloud()">üîÑ Refresh List</button>
        <button class="secondary" onclick="exportCSV()">üìä Export CSV</button>
    </div>

    <input type="text" id="searchInput" class="search-bar" placeholder="Search by name, ref, or solicitor..." onkeyup="render()">

    <div id="form" class="form-section">
        <h3 id="formTitle">Add Case</h3>
        <div class="form-row">
            <div><label>Case Ref *</label><input type="text" id="caseRef"></div>
            <div><label>Client Name *</label><input type="text" id="clientName"></div>
        </div>
        <div class="form-row">
            <div><label>Status</label>
                <select id="status">
                    <option>New</option><option>In Progress</option><option>On Hold</option><option>Closed</option>
                </select>
            </div>
            <div><label>Solicitor</label><input type="text" id="solicitor"></div>
        </div>
        <div class="form-row">
            <div><label>Next Review</label><input type="date" id="nextReview"></div>
            <div><label>Upload Document</label><input type="file" id="fileInput"></div>
        </div>
        <div style="margin-top: 10px;">
            <button id="saveBtn" onclick="saveCase()">Save Case & Sync</button>
            <button class="secondary" onclick="toggleForm()">Cancel</button>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Ref</th><th>Client</th><th>Status</th><th>Solicitor</th><th>Drive</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <div class="stats">
        <div class="stat-card"><span class="stat-val" id="totalCount">0</span><span class="stat-lbl">Total</span></div>
        <div class="stat-card"><span class="stat-val" id="activeCount">0</span><span class="stat-lbl">Active</span></div>
        <div class="stat-card"><span class="stat-val" id="closedCount">0</span><span class="stat-lbl">Closed</span></div>
    </div>
</div>

<script>
    // 1. UPDATE THIS URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqpD5hi7QtoRocqC15RNnYYOV1bv5QE72HRdtAH4N46YjPaaC1akawn98_NG_B7K5R/exec'; 

    let cases = JSON.parse(localStorage.getItem('cases')) || [];
    let editingId = null;

    function toggleForm() {
        const form = document.getElementById('form');
        form.classList.toggle('show');
        if (!form.classList.contains('show')) resetForm();
    }

    function resetForm() {
        editingId = null;
        document.getElementById('formTitle').innerText = "Add Case";
        document.getElementById('caseRef').value = '';
        document.getElementById('clientName').value = '';
        document.getElementById('solicitor').value = '';
        document.getElementById('fileInput').value = '';
    }

    async function saveCase() {
        const ref = document.getElementById('caseRef').value;
        const client = document.getElementById('clientName').value;
        if (!ref || !client) return alert("Required fields missing");

        const btn = document.getElementById('saveBtn');
        btn.disabled = true; btn.innerText = "Processing...";

        const fileInput = document.getElementById('fileInput');
        let fileData = null;
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const base64 = await toBase64(file);
            fileData = { data: base64.split(',')[1], name: file.name, type: file.type };
        }

        const caseObj = {
            id: editingId || Date.now(),
            caseRef: ref,
            clientName: client,
            status: document.getElementById('status').value,
            solicitor: document.getElementById('solicitor').value,
            nextReview: document.getElementById('nextReview').value,
            folderUrl: editingId ? (cases.find(c => c.id == editingId)?.folderUrl || "") : ""
        };

        if (editingId) {
            cases = cases.map(c => c.id == editingId ? caseObj : c);
        } else {
            cases.push(caseObj);
        }

        localStorage.setItem('cases', JSON.stringify(cases));
        render();
        
        await syncToCloud(caseObj.caseRef, fileData);
        
        btn.disabled = false; btn.innerText = "Save Case & Sync";
        toggleForm();
    }

    async function syncToCloud(targetRef = null, fileObj = null) {
        updateStatus("‚òÅÔ∏è Syncing...");
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ cases, targetRef, file: fileObj })
            });
            updateStatus("‚úÖ Cloud Updated");
        } catch (e) {
            updateStatus("‚ùå Sync Error");
        }
    }

    async function loadFromCloud() {
        updateStatus("‚è≥ Loading...");
        try {
            const resp = await fetch(SCRIPT_URL);
            const data = await resp.json();
            if (data && Array.isArray(data)) {
                cases = data;
                localStorage.setItem('cases', JSON.stringify(cases));
                render();
                updateStatus("‚úÖ Loaded");
            }
        } catch (e) {
            updateStatus("‚ùå Load Failed");
        }
    }

    function render() {
        const query = (document.getElementById('searchInput')?.value || "").toLowerCase();
        const tbody = document.getElementById('tbody');
        if(!tbody) return;
        tbody.innerHTML = '';

        const filtered = cases.filter(c => {
            const name = (c.clientName || c.clientname || "").toLowerCase();
            const ref = (c.caseRef || c.caseref || "").toLowerCase();
            return name.includes(query) || ref.includes(query);
        });

        filtered.forEach(c => {
            // Support both camelCase and lowercase keys from Google
            const displayRef = c.caseRef || c.caseref || 'N/A';
            const displayClient = c.clientName || c.clientname || 'Unknown';
            const displayStatus = c.status || 'New';
            const displaySolicitor = c.solicitor || '-';
            const displayFolder = c.folderUrl || c.folderurl || "";

            const row = `<tr>
                <td><strong>${displayRef}</strong></td>
                <td>${displayClient}</td>
                <td><span class="badge status-${displayStatus.toLowerCase().replace(/\s+/g, '')}">${displayStatus}</span></td>
                <td>${displaySolicitor}</td>
                <td>
                    ${displayFolder 
                        ? `<a href="${displayFolder}" target="_blank" class="drive-link">üìÅ Open Folder</a>` 
                        : `<span style="color:#888; font-size:11px;">‚è≥ Syncing...<br>(Refresh in 10s)</span>`}
                </td>
                <td>
                    <button class="secondary" style="padding:4px 8px" onclick="editCase(${c.id})">Edit</button>
                    <button class="danger" style="padding:4px 8px" onclick="deleteCase(${c.id})">Del</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        document.getElementById('totalCount').innerText = cases.length;
        document.getElementById('activeCount').innerText = cases.filter(c => (c.status || '').toLowerCase() !== 'closed').length;
        document.getElementById('closedCount').innerText = cases.filter(c => (c.status || '').toLowerCase() === 'closed').length;
    }

    function deleteCase(id) {
        if (confirm("Delete this case?")) {
            cases = cases.filter(c => c.id != id);
            localStorage.setItem('cases', JSON.stringify(cases));
            render();
            syncToCloud();
        }
    }

    function editCase(id) {
        const c = cases.find(x => x.id == id);
        if(!c) return;
        editingId = id;
        document.getElementById('formTitle').innerText = "Edit Case";
        document.getElementById('caseRef').value = c.caseRef || '';
        document.getElementById('clientName').value = c.clientName || '';
        document.getElementById('status').value = c.status || 'New';
        document.getElementById('solicitor').value = c.solicitor || '';
        document.getElementById('nextReview').value = c.nextReview || '';
        document.getElementById('form').classList.add('show');
    }

    function exportCSV() {
        let csv = "Ref,Client,Status,Solicitor,Review,Folder\n";
        cases.forEach(c => {
            csv += `"${c.caseRef}","${c.clientName}","${c.status}","${c.solicitor}","${c.nextReview}","${c.folderUrl}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cases_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    function updateStatus(msg) {
        const el = document.getElementById('syncStatus');
        if(el) el.innerText = msg;
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    // START THE APP
    render();
</script>

</body>
</html>
